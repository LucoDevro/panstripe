#' compare_pangenomes
#'
#' Compares pangenomes using anova
#'
#' @param fitA a `panfit` object generated by the `panstripe` function
#' @param fitB a `panfit` object generated by the `panstripe` function
#'
#' @return a list containing a summary of the comparison and the resulting `glm` model object
#'
#' @examples
#'
#' simA <- simulate_pan(rate=1e-3)
#' simB <- simulate_pan(rate=1e-4)
#' fA <- panstripe(simA$pa, simA$tree, nboot=0)
#' fB <- panstripe(simB$pa, simB$tree, nboot=0)
#' comp <- compare_pangenomes(fA, fB)
#'
#' @export
compare_pangenomes <- function(fitA, fitB){
  
  # input checks
  if (class(fitA) != 'panfit') stop('fitA is not of class `panfit`!')
  validate_panfit(fitA)
  if (class(fitB) != 'panfit') stop('fitB is not of class `panfit`!')
  validate_panfit(fitB)
  
  #combine data
  dat <- purrr::imap_dfr(list(fitA, fitB), ~{
    tibble::add_column(.x$data, pangenome=LETTERS[[.y]], .before=1)
  })
  dat$istip <- 1*dat$istip
  
  # fit model
  model <- stats::as.formula("acc ~ core*istip + height + height:core + istip:pangenome + core:pangenome")
  
  if (sum(dat$acc[!dat$istip])<3){
    warning("No gene gain/loss events inferred in ancestral branches! Setting tweedie power=1")
    ef <- list(p.max=1)
  } else {
    invisible(suppressWarnings(utils::capture.output({
      ef <- tweedie::tweedie.profile(model, 
                                     data = dat[!dat$istip, , drop=FALSE], p.vec = seq(1.1,1.9,0.1),
                                     do.smooth = TRUE, method="series")
    })))
  }
  
  m <- stats::glm(model, data = dat, 
                  family = statmod::tweedie(var.power = ef$p.max, link.power = 0))
  
  s <- broom::tidy(m)
  s <- s[s$term %in% c('istip:pangenomeB', 'core:pangenomeB'), , drop=FALSE]
  s$term <- ifelse(s$term=='core:pangenomeB', 'core', 'tip')
  
  return(list(
    summary=s,
    model=m
  ))
  
}

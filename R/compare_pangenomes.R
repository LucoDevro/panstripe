#' compare_pangenomes
#'
#' Compares pangenomes using anova
#'
#' @param fitA a `panfit` object generated by the `panstripe` function
#' @param fitB a `panfit` object generated by the `panstripe` function
#' @param max_height the maximum height of branches to consider (all branches will be considered by default)
#'
#' @return a list containing a summary of the comparison and the resulting `glm` model object
#'
#' @examples
#'
#' simA <- simulate_pan(rate=1e-3, ngenomes = 200, fn_error_rate=1, fp_error_rate=1)
#' simB <- simulate_pan(rate=1e-3, ngenomes = 200, fn_error_rate=1, fp_error_rate=1)
#' fitA <- panstripe(simA$pa, simA$tree, nboot=0)
#' fitB <- panstripe(simB$pa, simB$tree, nboot=0)
#' comp <- compare_pangenomes(fitA, fitB)
#'
#' @export
compare_pangenomes <- function(fitA, fitB, max_height=NULL){
  
  # input checks
  if (class(fitA) != 'panfit') stop('fitA is not of class `panfit`!')
  validate_panfit(fitA)
  if (class(fitB) != 'panfit') stop('fitB is not of class `panfit`!')
  validate_panfit(fitB)
  
  #combine data
  dat <- purrr::imap_dfr(list(fitA, fitB), ~{
    tibble::add_column(.x$data, pangenome=LETTERS[[.y]], .before=1)
  })
  
  if(!is.null(max_height)){
    dat <- dat[dat$height<=max_height,,drop=FALSE]
  }
  
  # fit model
  model <- stats::as.formula("acc ~ 0 + core*istip + height + height:core + istip:pangenome + core:pangenome")
  
  if (sum(dat$acc[!dat$istip])<3){
    warning("Very few gene gain/loss events inferred in ancestral branches - fitting Poisson!")
    m <- glmmTMB::glmmTMB(model, data = dat, family = poisson)
  } else {
    m <- glmmTMB::glmmTMB(model, data = dat, family = glmmTMB::tweedie)
  }
  
  s <- summary(m)$coefficients$cond %>% 
    tibble::as_tibble(rownames = 'term')
  s <- s[s$term %in% c('istipTRUE:pangenomeB', 'core:pangenomeB'), , drop=FALSE]
  s$term <- ifelse(s$term=='core:pangenomeB', 'core', 'tip')
  colnames(s) <- c('term','estimate','std.error','statistic','p.value')
  
  return(list(
    summary=s,
    model=m
  ))
  
}
